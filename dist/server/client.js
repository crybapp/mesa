"use strict";var _interopRequireDefault=require("@babel/runtime/helpers/interopRequireDefault"),_classCallCheck2=_interopRequireDefault(require("@babel/runtime/helpers/classCallCheck")),_createClass2=_interopRequireDefault(require("@babel/runtime/helpers/createClass")),_possibleConstructorReturn2=_interopRequireDefault(require("@babel/runtime/helpers/possibleConstructorReturn")),_getPrototypeOf2=_interopRequireDefault(require("@babel/runtime/helpers/getPrototypeOf")),_inherits2=_interopRequireDefault(require("@babel/runtime/helpers/inherits")),__importDefault=function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(exports,"__esModule",{value:!0});var events_1=__importDefault(require("events")),message_1=__importDefault(require("./message")),Client=function(e){function Client(e,t){var s;return(0,_classCallCheck2.default)(this,Client),(s=(0,_possibleConstructorReturn2.default)(this,(0,_getPrototypeOf2.default)(Client).call(this))).messages={sent:[],recieved:[]},s.heartbeatCount=0,s.heartbeatAttempts=0,s.heartbeatBuffer=[],s.socket=e,s.server=t,s.setup(),s}return(0,_inherits2.default)(Client,e),(0,_createClass2.default)(Client,[{key:"setup",value:function setup(){var e=this,t=this.socket;this.server.heartbeatConfig.enabled&&(this.heartbeatMaxAttempts=this.server.heartbeatConfig.maxAttempts||3,this.heartbeatInterval=setInterval((function(){return e.heartbeat()}),this.server.heartbeatConfig.interval)),t.on("message",(function(t){return e.registerMessage(t)})),t.on("close",(function(t,s){return e.registerDisconnection(t,s)}))}},{key:"send",value:function send(e){this.messages.sent.push(e),this.socket.send(e.serialize())}},{key:"heartbeat",value:function heartbeat(){if(this.heartbeatBuffer.length>0||0===this.heartbeatCount)this.heartbeatBuffer=[],this.heartbeatAttempts=0,this.send(new message_1.default(1,{}));else{if(this.heartbeatAttempts+=1,this.heartbeatAttempts>this.heartbeatMaxAttempts)return this.disconnect();this.send(new message_1.default(1,{tries:this.heartbeatAttempts,max:this.heartbeatMaxAttempts}))}this.heartbeatCount+=1}},{key:"authenticate",value:function authenticate(e){this.authenticationCheck=e}},{key:"registerMessage",value:function registerMessage(e){var t;try{t=JSON.parse(e.toString())}catch(e){throw e}var s=t,r=s.op,i=s.d,a=s.t,n=new message_1.default(r,i,a);return 2===r&&this.authenticationCheck?this.authenticationCheck(i,this.registerAuthentication):11===r?this.heartbeatBuffer.push(n):(this.emit("message",n),this.server.emit("message",n),void this.messages.recieved.push(n))}},{key:"registerAuthentication",value:function registerAuthentication(e,t){console.log(e,t)}},{key:"registerDisconnection",value:function registerDisconnection(e,t){this.heartbeatInterval&&clearInterval(this.heartbeatInterval),this.emit("disconnect",{code:e,reason:t})}},{key:"disconnect",value:function disconnect(e){this.socket.close(e)}}]),Client}(events_1.default);exports.default=Client;